# Data Model: Frontend–Backend Integration for RAG Chatbot

## Entities

### UserQuery
- **Description**: Represents a query submitted by the user to the RAG agent
- **Fields**:
  - `query_text` (string): The text of the user's query (500-1000 character limit)
  - `selected_text` (string, optional): Optional text selected by the user in the book content (included as context in the query)
  - `timestamp` (datetime): When the query was submitted
  - `user_context` (object, optional): Additional context about the user's current location in the book

### RAGResponse
- **Description**: The response generated by the RAG agent based on the user's query
- **Fields**:
  - `query_text` (string): Echo of the original query
  - `answer` (string): The generated answer to the query
  - `retrieved_chunks` (array of objects): Content chunks retrieved from the vector database
    - `content` (string): The text content of the chunk
    - `similarity_score` (float): How similar this chunk is to the query
    - `metadata` (object): Additional metadata about the source
      - `url` (string): URL where this content originated
      - `title` (string): Title of the source document
      - `chunk_index` (integer): Position of this chunk in the original document
  - `confidence_score` (float): Overall confidence in the answer
  - `execution_time` (float): Time taken to generate the response
  - `timestamp` (datetime): When the response was generated

### ChatMessage
- **Description**: A single message in the chat conversation
- **Fields**:
  - `id` (string): Unique identifier for the message
  - `role` (string): Either "user" or "assistant"
  - `content` (string): The text content of the message
  - `timestamp` (datetime): When the message was created
  - `sources` (array of objects, optional): Source references for the response with citations and links to original content

## State Transitions

### Query Processing States
1. `submitted` → Query sent from frontend to backend
2. `processing` → RAG agent is retrieving and generating response
3. `completed` → Response is ready to be sent to frontend
4. `error` → Error occurred during processing
5. `retry_pending` → User requested retry after error

## Validation Rules

### UserQuery Validation
- `query_text` must be between 1 and 1000 characters (with clear user feedback if exceeded)
- `query_text` must not be empty after trimming whitespace
- `selected_text` if provided, must be between 1 and 5000 characters
- If `selected_text` is provided, it should be included as context in the query processing

### RAGResponse Validation
- `answer` must be provided and not empty
- `confidence_score` must be between 0.0 and 1.0
- `execution_time` must be positive
- `retrieved_chunks` must contain at least 1 item when answer is generated
- Each chunk in `retrieved_chunks` must include proper source citations and links to original content

### ChatMessage Validation
- `role` must be either "user" or "assistant"
- `content` must not be empty
- If `sources` are provided, each source must include URL and title for proper citation